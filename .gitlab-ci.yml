image: registry.gitlab.com/grupo-esfera/capacitacion/recursos/repartir

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.caching=true"

stages:
  - instalar_dependencias
  - build
  - analyze
  - test
  - report
  - package
  - deploy

before_script:
  - export GRADLE_USER_HOME=cache/

cache:
  paths:
    - cache/caches/
    - cache/notifications/
    - cache/wrapper/
    - cache/build-cache/

instalar_dependencias:
  stage: instalar_dependencias
  script:
    - cd src/main/frontend
    - npm ci --prefer-offline
    - PLAYWRIGHT_BROWSERS_PATH=0 npx playwright install
  cache:
    - key:
        files:
          - src/main/frontend/package-lock.json
        prefix: "$CI_COMMIT_REF_SLUG"
      paths:
        - src/main/frontend/node_modules
      policy: pull-push

build:
  stage: build
  script:
    - ./gradlew --build-cache assemble --info
  artifacts:
    when: on_success
    paths:
      - build/classes


unit-test:
  stage: test
  script:
    - ./gradlew test --info
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/**/TEST-*.xml
    paths:
      - build/jacoco
      - build/reports/tests/test

integration-test:
  stage: test
  script:
    - ./gradlew integrationTest --info
  artifacts:
    when: always
    reports:
      junit: build/test-results/integrationTest/**/TEST-*.xml
    paths:
      - build/jacoco
      - build/reports/tests/integrationTest

ui-test:
  stage: test
  script:
    - export CHROME_OPTIONS="--headless, --no-sandbox"
    - ./gradlew uiTest --info
  artifacts:
    when: always
    reports:
      junit: build/test-results/uiTest/**/TEST-*.xml
    paths:
      - build/jacoco
      - build/reports/tests/uiTest

acceptance-test:
  stage: test
  script:
    - export CHROME_OPTIONS='--headless, --no-sandbox'
    - ./gradlew acceptanceTest --info
  artifacts:
    when: always
    reports:
      junit: build/test-results/acceptanceTest/**/TEST-*.xml
    paths:
      - build/jacoco
      - build/reports/tests/acceptanceTest
      - build/reports/acceptance.html

acceptance-test-js:
  stage: test
  script:
    - PLAYWRIGHT_BROWSERS_PATH=node_modules/playwright-core/.local-browsers ./tests js acceptance
  cache:
    key:
      files:
        - src/main/frontend/package-lock.json
      prefix: "$CI_COMMIT_REF_SLUG"
    paths:
      - src/main/frontend/node_modules
    policy: pull

package:
  stage: package
  script:
    - echo "Packaging"

report-test-coverage:
  stage: report
  script:
    - ./gradlew jacocoTestReport --info
  artifacts:
    when: always
    paths:
      - build/reports/jacoco

static-source-code-analysis:
  stage: analyze
  script:
    - ./gradlew pmdMain
  artifacts:
    when: always
    paths:
      - build/reports/pmd

deploy-dev:
  stage: deploy
  script:
    - echo "Deploying application to DEV..."
    - echo "Application successfully deployed."
